{{/* layouts/shortcodes/contraction-timer.html */}}
<style>
    /* --- Basic Styling --- */
    .contraction-timer-container {
        max-width: 700px; margin: 20px auto; background: #fff; padding: 30px;
        border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        font-family: sans-serif; line-height: 1.6; color: #333;
    }
    .contraction-timer-container h2 {
        text-align: center; color: #333 !important; margin-top: 0; margin-bottom: 1em;
    }
    .timer-controls { text-align: center; margin-bottom: 30px; }
    .timer-display p { margin: 5px 0; color: #333 !important; font-size: 1.1em; }
    .timer-display span { font-weight: bold; color: #333; margin-left: 5px; }

     /* --- Buttons --- */
    #timerButton, #saveHistoryButton, #clearHistoryButton,
    #exportHistoryButton, #importHistoryButton { /* Added new button IDs */
        padding: 10px 20px; font-size: 1.1em; cursor: pointer; border: none;
        border-radius: 5px; color: white; transition: background-color 0.3s ease;
        margin: 5px;
    }
    #timerButton { padding: 15px 30px; font-size: 1.2em; background-color: #28a745; }
    #timerButton.timing { background-color: #dc3545; }
    #saveHistoryButton { background-color: #007bff; }
    #saveHistoryButton:hover { background-color: #0056b3; }
    #clearHistoryButton { background-color: #6c757d; }
    #clearHistoryButton:hover { background-color: #5a6268; }
    #exportHistoryButton { background-color: #ffc107; color: #333;} /* Yellow */
    #exportHistoryButton:hover { background-color: #e0a800; }
    #importHistoryButton { background-color: #17a2b8; } /* Teal */
    #importHistoryButton:hover { background-color: #117a8b; }

     /* --- Table --- */
    #historyTable { width: 100%; border-collapse: collapse; margin-top: 20px; }
    #historyTable th, #historyTable td { border: 1px solid #ddd; padding: 10px; text-align: left; color: #333; }
    #historyTable th { background-color: #e9e7fd; }
    #historyTable tbody tr:nth-child(even) { background-color: #f9f9f9; }

     /* --- Import Section --- */
     .import-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; }
     .import-section label { display: block; margin-bottom: 5px; font-weight: bold; }
     #importDataArea {
        width: 95%; /* Avoid full width to prevent scrollbar issues */
        min-height: 80px;
        margin-bottom: 10px;
        font-family: monospace;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 5px;
     }
     .import-button-container { text-align: center; } /* Center import button */

     /* --- Other --- */
     .button-section { text-align: center; margin-top: 30px; }
     #storageStatus { text-align: center; font-style: italic; font-size: 0.9em; color: #555; margin-top: 15px; min-height: 1.2em; }
    .no-history { text-align: center; color: #333; margin-top: 15px; }
</style>

<div class="contraction-timer-container">
    <h2>Contraction Timer</h2>

    <div class="timer-controls">
        <button id="timerButton">Start Contraction</button>
        <div class="timer-display">
            <p>Current Duration:<span id="currentDuration">00:00</span></p>
            <p>Time Since Last Start:<span id="timeSinceLast">--:--</span></p>
        </div>
    </div>

    <h2>Contraction History</h2>
    <table id="historyTable">
        <thead>
            <tr> <th>Start Time</th> <th>Duration</th> <th>Frequency (Start to Start)</th> </tr>
        </thead>
        <tbody id="historyBody">
            <tr id="no-history-row">
               <td colspan="3" class="no-history">No contractions recorded yet. Load saved history, import data, or start timing.</td>
            </tr>
        </tbody>
    </table>

    <div class="button-section">
        <button id="saveHistoryButton">Save History</button>
        <button id="exportHistoryButton">Export History</button> <button id="clearHistoryButton">Clear History</button>
        <p id="storageStatus"></p>
    </div>

    <div class="import-section">
        <h3>Import History</h3>
        <label for="importDataArea">Paste previously exported data here:</label>
        <textarea id="importDataArea" rows="4"></textarea>
        <div class="import-button-container">
            <button id="importHistoryButton">Import Data (Replaces Current)</button>
        </div>
    </div>

</div>

<script>
(function() {
    // DOM Elements
    const timerButton = document.getElementById('timerButton');
    const currentDurationEl = document.getElementById('currentDuration');
    const timeSinceLastEl = document.getElementById('timeSinceLast');
    const historyBody = document.getElementById('historyBody');
    const clearHistoryButton = document.getElementById('clearHistoryButton');
    const saveHistoryButton = document.getElementById('saveHistoryButton');
    const storageStatus = document.getElementById('storageStatus');
    const exportHistoryButton = document.getElementById('exportHistoryButton'); // New Export Button
    const importDataArea = document.getElementById('importDataArea');         // New Import Textarea
    const importHistoryButton = document.getElementById('importHistoryButton'); // New Import Button

    // State Variables
    let isTiming = false;
    let startTime = null;
    let lastStartTime = null;
    let timerInterval = null;
    let timeSinceLastInterval = null;
    let contractions = [];

    const STORAGE_KEY = 'contractionHistory';

    // --- Local Storage & Data Handling ---
    function saveHistoryToStorage() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(contractions));
            displayStatus("History saved to browser storage.", 3000);
        } catch (e) {
            console.error("Error saving history:", e);
            displayStatus("Error saving history.", 5000);
        }
    }

    function loadHistoryFromStorage() {
        const storedHistory = localStorage.getItem(STORAGE_KEY);
        let loaded = false;
        if (storedHistory) {
            try {
                const parsedHistory = JSON.parse(storedHistory);
                if (isValidHistoryData(parsedHistory)) { // Use validation function
                    contractions = parsedHistory;
                    loaded = true;
                } else {
                    console.error("Stored history data format is invalid, clearing.");
                    localStorage.removeItem(STORAGE_KEY);
                    contractions = [];
                }
            } catch (e) {
                console.error("Error parsing stored history:", e);
                localStorage.removeItem(STORAGE_KEY);
                contractions = [];
            }
        } else {
            contractions = [];
        }
        lastStartTime = contractions.length > 0 ? contractions[0].startTime : null;
        return loaded;
    }

    // Basic validation for imported/loaded data
    function isValidHistoryData(data) {
         if (!Array.isArray(data)) return false;
         // Check if every item looks like a contraction record (can be more thorough)
         return data.every(item =>
              typeof item === 'object' && item !== null &&
              typeof item.startTime === 'number' && // Expecting timestamp number
              typeof item.duration === 'number' &&
              (typeof item.frequency === 'number' || item.frequency === null)
          );
    }

    // --- Helper Functions ---
    function displayStatus(message, durationMs = 0) { /* ... same as before ... */ }
    function formatTime(totalSeconds) { /* ... same as before ... */ }
    function formatTimestamp(timestamp) { /* ... same as before ... */ }
    function updateDurationDisplay() { /* ... same as before ... */ }
    function updateTimeSinceLastDisplay() { /* ... same as before ... */ }
    function updateHistoryTable() { /* ... mostly same, update no-history text ... */
        if (!historyBody) return;
        historyBody.innerHTML = '';

        if (contractions.length === 0) {
            const row = historyBody.insertRow();
            const cell = row.insertCell();
            cell.colSpan = 3;
            cell.className = 'no-history';
             // Updated message
             cell.textContent = 'No history yet. Start timing, load saved data, or import data.';
        } else {
            contractions.forEach((contraction, index) => {
                const row = historyBody.insertRow();
                const cellStartTime = row.insertCell();
                const cellDuration = row.insertCell();
                const cellFrequency = row.insertCell();
                cellStartTime.textContent = formatTimestamp(contraction.startTime);
                cellDuration.textContent = formatTime(contraction.duration);
                // Frequency is null for the first contraction recorded (which ends up last in the array due to unshift)
                 // Let's adjust logic slightly: The item added first (now last) has no prior.
                 // The frequency stored belongs to the *start* of that contraction relative to the *previous* start.
                 cellFrequency.textContent = contraction.frequency === null ? "N/A" : formatTime(contraction.frequency);
            });
        }
    }

    // --- Event Handlers ---
    function handleTimerClick() { /* ... same as before (stores timestamp number, no auto-save) ... */ }
    function handleSaveHistoryClick() { /* ... same as before ... */ }
    function handleClearHistoryClick() { /* ... same as before ... */ }

    // *** NEW: Export Handler ***
    function handleExportHistoryClick() {
        if (contractions.length === 0) {
            displayStatus("No history to export.", 3000);
            return;
        }
        try {
            const jsonData = JSON.stringify(contractions, null, 2); // Pretty print JSON
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            // Create filename with date/time
            const now = new Date();
            const timestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
            link.download = `contraction_history_${timestamp}.json`;
            document.body.appendChild(link); // Required for Firefox
            link.click();
            document.body.removeChild(link); // Clean up
            URL.revokeObjectURL(url); // Free up memory
            displayStatus("History exported as JSON file.", 3000);
        } catch (e) {
             console.error("Error exporting history:", e);
             displayStatus("Error exporting history.", 5000);
             // Fallback: Copy to clipboard (might require user interaction/permission)
             try {
                 const jsonDataPlain = JSON.stringify(contractions);
                 navigator.clipboard.writeText(jsonDataPlain).then(() => {
                    alert("Could not download file. History copied to clipboard instead.");
                 }).catch(err => {
                    console.error('Clipboard fallback failed:', err);
                    alert("Could not download file or copy to clipboard. Please check console.");
                 });
             } catch (fallbackError) {
                 console.error("Fallback export error:", fallbackError);
                 alert("Could not download file or copy to clipboard. Please check console.");
             }
        }
    }

    // *** NEW: Import Handler ***
    function handleImportHistoryClick() {
        if (!importDataArea || !importHistoryButton) return;
        const pastedData = importDataArea.value.trim();

        if (!pastedData) {
            displayStatus("Paste exported data into the text area first.", 3000);
            return;
        }

        // Confirm before replacing existing data
        if (contractions.length > 0) {
            if (!confirm("Importing will replace your current history list. Continue?")) {
                return; // User cancelled
            }
        }

        try {
            const parsedData = JSON.parse(pastedData);

            // Validate the parsed data structure
            if (!isValidHistoryData(parsedData)) {
                 throw new Error("Imported data is not in the expected format (array of contraction records).");
            }

            // Replace current history
            contractions = parsedData;
            // Update lastStartTime based on imported data (newest first)
            lastStartTime = contractions.length > 0 ? contractions[0].startTime : null;

            // Update UI
            updateHistoryTable();
            updateTimeSinceLastDisplay();
            importDataArea.value = ''; // Clear textarea
            displayStatus("History imported successfully.", 3000);

            // Optional: Prompt user if they want to save the imported data now
            // if (confirm("History imported. Do you want to save this imported history to browser storage now?")) {
            //     saveHistoryToStorage();
            // }

        } catch (e) {
            console.error("Error importing history:", e);
            displayStatus(`Import failed: ${e.message}`, 5000);
        }
    }


    // --- Initialization ---
    if (loadHistoryFromStorage()) {
       displayStatus("Loaded previously saved history.", 3000);
    }

    // Add event listeners
    if (timerButton) timerButton.addEventListener('click', handleTimerClick);
    if (clearHistoryButton) clearHistoryButton.addEventListener('click', handleClearHistoryClick);
    if (saveHistoryButton) saveHistoryButton.addEventListener('click', handleSaveHistoryClick);
    if (exportHistoryButton) exportHistoryButton.addEventListener('click', handleExportHistoryClick); // Add listener
    if (importHistoryButton) importHistoryButton.addEventListener('click', handleImportHistoryClick); // Add listener

    // Initial render
    updateHistoryTable();
    updateTimeSinceLastDisplay();

})();
</script>