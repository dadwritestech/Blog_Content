{{/* layouts/shortcodes/contraction-timer.html */}}
<style>
    /* --- Basic Styling --- */
    .contraction-timer-container {
        max-width: 700px;
        margin: 20px auto;
        background: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        font-family: sans-serif;
        line-height: 1.6;
        color: #333;
    }

    .contraction-timer-container h2 {
        text-align: center;
        color: #333 !important;
        margin-top: 0;
        margin-bottom: 1em;
    }

    .contraction-timer-container h3 {
        text-align: center;
        color: #333 !important;
        margin-top: 0;
        margin-bottom: 1em;
    }

    .timer-controls {
        text-align: center;
        margin-bottom: 30px;
    }

    .timer-display p {
        margin: 5px 0;
        color: #333 !important;
        font-size: 1.1em;
    }

    .timer-display span {
        font-weight: bold;
        color: #333;
        margin-left: 5px;
    }

    /* --- Buttons --- */
    #timerButton,
    #saveHistoryButton,
    #clearHistoryButton,
    #exportHistoryButton,
    #importHistoryButton {
        /* Added new button IDs */
        padding: 10px 20px;
        font-size: 1.1em;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        color: white;
        transition: background-color 0.3s ease;
        margin: 5px;
    }

    #timerButton {
        padding: 15px 30px;
        font-size: 1.2em;
        background-color: #28a745;
    }

    #timerButton.timing {
        background-color: #dc3545;
    }

    #saveHistoryButton {
        background-color: #007bff;
    }

    #saveHistoryButton:hover {
        background-color: #0056b3;
    }

    #clearHistoryButton {
        background-color: #6c757d;
    }

    #clearHistoryButton:hover {
        background-color: #5a6268;
    }

    #exportHistoryButton {
        background-color: #ffc107;
        color: #333;
    }

    /* Yellow */
    #exportHistoryButton:hover {
        background-color: #e0a800;
    }

    #importHistoryButton {
        background-color: #17a2b8;
    }

    /* Teal */
    #importHistoryButton:hover {
        background-color: #117a8b;
    }

    /* --- Table --- */
    #historyTable {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    #historyTable th,
    #historyTable td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: left;
        color: #333;
    }

    #historyTable th {
        background-color: #e9e7fd;
    }

    #historyTable tbody tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    /* --- Import Section --- */
    .import-section {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }

    .import-section label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }

    #importDataArea {
        width: 95%;
        /* Avoid full width to prevent scrollbar issues */
        min-height: 80px;
        margin-bottom: 10px;
        font-family: monospace;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 5px;
    }

    .import-button-container {
        text-align: center;
    }

    /* Center import button */

    /* --- Other --- */
    .button-section {
        text-align: center;
        margin-top: 30px;
    }

    #storageStatus {
        text-align: center;
        font-style: italic;
        font-size: 0.9em;
        color: #555;
        margin-top: 15px;
        min-height: 1.2em;
    }

    .no-history {
        text-align: center;
        color: #333;
        margin-top: 15px;
    }
</style>

<div class="contraction-timer-container">
    <h2>Contraction Timer</h2>

    <div class="timer-controls">
        <button id="timerButton">Start Contraction</button>
        <div class="timer-display">
            <p>Current Duration:<span id="currentDuration">00:00</span></p>
            <p>Time Since Last Start:<span id="timeSinceLast">--:--</span></p>
        </div>
    </div>

    <h2>Contraction History</h2>
    <table id="historyTable">
        <thead>
            <tr>
                <th>Start Time</th>
                <th>Duration</th>
                <th>Frequency (Start to Start)</th>
            </tr>
        </thead>
        <tbody id="historyBody">
            <tr id="no-history-row">
                <td colspan="3" class="no-history">No contractions recorded yet. Load saved history, import data, or
                    start timing.</td>
            </tr>
        </tbody>
    </table>

    <div class="button-section">
        <button id="saveHistoryButton">Save History</button>
        <button id="exportHistoryButton">Export History</button> <button id="clearHistoryButton">Clear History</button>
        <p id="storageStatus"></p>
    </div>

    <div class="import-section">
        <h3>Import History</h3>
        <label for="importDataArea">Paste previously exported data here:</label>
        <textarea id="importDataArea" rows="4"></textarea>
        <div class="import-button-container">
            <button id="importHistoryButton">Import Data (Replaces Current)</button>
        </div>
    </div>

</div>

<script>
    (function() {
        // --- DOM Elements ---
        const timerButton = document.getElementById('timerButton');
        const currentDurationEl = document.getElementById('currentDuration');
        const timeSinceLastEl = document.getElementById('timeSinceLast');
        const historyBody = document.getElementById('historyBody');
        const clearHistoryButton = document.getElementById('clearHistoryButton');
        const saveHistoryButton = document.getElementById('saveHistoryButton');
        const storageStatus = document.getElementById('storageStatus');
        const exportHistoryButton = document.getElementById('exportHistoryButton'); // Export Button
        const importDataArea = document.getElementById('importDataArea');         // Import Textarea
        const importHistoryButton = document.getElementById('importHistoryButton'); // Import Button
    
        // --- State Variables ---
        let isTiming = false;
        let startTime = null;       // Timestamp number
        let lastStartTime = null;   // Timestamp number
        let timerInterval = null;
        let timeSinceLastInterval = null;
        let contractions = [];      // {startTime: number, duration: number, frequency: number|null}
    
        const STORAGE_KEY = 'contractionHistory';
    
        // --- Local Storage & Data Handling ---
        function saveHistoryToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(contractions));
                displayStatus("History saved to browser storage.", 3000);
            } catch (e) {
                console.error("Error saving history:", e);
                displayStatus("Error saving history.", 5000);
            }
        }
    
        function loadHistoryFromStorage() {
            const storedHistory = localStorage.getItem(STORAGE_KEY);
            let loaded = false;
            if (storedHistory) {
                try {
                    const parsedHistory = JSON.parse(storedHistory);
                    if (isValidHistoryData(parsedHistory)) {
                        contractions = parsedHistory;
                        loaded = true;
                    } else {
                        console.error("Stored history data format is invalid, clearing.");
                        localStorage.removeItem(STORAGE_KEY);
                        contractions = [];
                    }
                } catch (e) {
                    console.error("Error parsing stored history:", e);
                    localStorage.removeItem(STORAGE_KEY);
                    contractions = [];
                }
            } else {
                contractions = [];
            }
            lastStartTime = contractions.length > 0 ? contractions[0].startTime : null;
            return loaded;
        }
    
        function isValidHistoryData(data) {
            if (!Array.isArray(data)) return false;
            return data.every(item =>
                typeof item === 'object' && item !== null &&
                typeof item.startTime === 'number' &&
                typeof item.duration === 'number' &&
                (typeof item.frequency === 'number' || item.frequency === null)
            );
        }
    
        // --- Helper Functions ---
        function displayStatus(message, durationMs = 0) {
            if (storageStatus) {
                storageStatus.textContent = message;
                if (durationMs > 0) {
                    setTimeout(() => {
                        if (storageStatus.textContent === message) {
                           storageStatus.textContent = '';
                        }
                    }, durationMs);
                }
            }
        }
    
        function formatTime(totalSeconds) {
            if (totalSeconds === null || isNaN(totalSeconds)) return "--:--";
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.floor(totalSeconds % 60);
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
    
        function formatTimestamp(timestamp) {
            if (!timestamp || isNaN(timestamp)) return "N/A";
            const date = new Date(timestamp);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }
    
        function updateDurationDisplay() {
            if (!startTime) return;
            const now = Date.now();
            const elapsedSeconds = (now - startTime) / 1000;
            if (currentDurationEl) currentDurationEl.textContent = formatTime(elapsedSeconds);
        }
    
        function updateTimeSinceLastDisplay() {
            if (!lastStartTime) {
                if (timeSinceLastEl) timeSinceLastEl.textContent = '--:--';
                return;
            };
            const now = Date.now();
            const elapsedSeconds = (now - lastStartTime) / 1000;
            if (timeSinceLastEl) timeSinceLastEl.textContent = formatTime(elapsedSeconds);
        }
    
        function updateHistoryTable() {
            if (!historyBody) return;
            historyBody.innerHTML = '';
    
            if (contractions.length === 0) {
                const row = historyBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 3;
                cell.className = 'no-history';
                cell.textContent = 'No history yet. Start timing, load saved data, or import data.';
            } else {
                contractions.forEach((contraction, index) => {
                    const row = historyBody.insertRow();
                    const cellStartTime = row.insertCell();
                    const cellDuration = row.insertCell();
                    const cellFrequency = row.insertCell();
                    cellStartTime.textContent = formatTimestamp(contraction.startTime);
                    cellDuration.textContent = formatTime(contraction.duration);
                    cellFrequency.textContent = contraction.frequency === null ? "N/A" : formatTime(contraction.frequency);
                });
            }
        }
    
        // --- Event Handlers ---
        function handleTimerClick() {
            if (!timerButton || !currentDurationEl || !timeSinceLastEl || !historyBody) return;
            const now = Date.now();
    
            if (!isTiming) {
                // STARTING
                isTiming = true;
                startTime = now;
                clearInterval(timerInterval);
                timerInterval = setInterval(updateDurationDisplay, 500);
                updateDurationDisplay();
                clearInterval(timeSinceLastInterval);
                timerButton.textContent = 'Stop Contraction';
                timerButton.classList.add('timing');
            } else {
                // STOPPING
                isTiming = false;
                const endTime = now;
                const duration = (endTime - startTime) / 1000;
                clearInterval(timerInterval);
                currentDurationEl.textContent = formatTime(duration);
    
                let frequency = null;
                if (lastStartTime) {
                    frequency = (startTime - lastStartTime) / 1000;
                }
    
                const contractionRecord = {
                    startTime: startTime, // Store timestamp number
                    duration: duration,
                    frequency: frequency
                };
                contractions.unshift(contractionRecord);
                updateHistoryTable();
                // No automatic save
    
                lastStartTime = startTime;
                startTime = null;
                clearInterval(timeSinceLastInterval);
                timeSinceLastInterval = setInterval(updateTimeSinceLastDisplay, 1000);
                updateTimeSinceLastDisplay();
                timerButton.textContent = 'Start Contraction';
                timerButton.classList.remove('timing');
            }
        }
    
        function handleSaveHistoryClick() {
            if (contractions.length === 0) {
                 displayStatus("No history to save.", 3000);
                 return;
            }
            if (confirm("Save contraction history?\n\nThis will store the current history list in your browser's local storage for your next visit.\nData is NOT sent anywhere else.")) {
                saveHistoryToStorage();
            }
        }
    
        function handleClearHistoryClick() {
            if (!clearHistoryButton) return;
            let confirmMsg = "Are you sure you want to clear the current history list?";
            let historyIsSaved = localStorage.getItem(STORAGE_KEY) !== null;
    
            if (contractions.length === 0 && !historyIsSaved) {
                displayStatus("History is already empty.", 3000);
                return;
            }
            if (historyIsSaved) {
                confirmMsg += "\n\nThis will ALSO delete any previously saved history from your browser storage.";
            }
    
            if (confirm(confirmMsg)) {
                contractions = [];
                lastStartTime = null;
                startTime = null;
                isTiming = false;
    
                clearInterval(timerInterval);
                clearInterval(timeSinceLastInterval);
    
                if(currentDurationEl) currentDurationEl.textContent = '00:00';
                if(timeSinceLastEl) timeSinceLastEl.textContent = '--:--';
                if(timerButton) {
                     timerButton.textContent = 'Start Contraction';
                     timerButton.classList.remove('timing');
                }
    
                if (historyIsSaved) {
                     localStorage.removeItem(STORAGE_KEY);
                }
                updateHistoryTable();
                displayStatus("History cleared.", 3000);
            }
        }
    
        // *** MODIFIED: Export Handler - Asks User Choice ***
        function handleExportHistoryClick() {
            if (contractions.length === 0) {
                displayStatus("No history to export.", 3000);
                return;
            }
    
            // Ask user for preference
            const choice = prompt("Choose export method:\nType 'D' to Download file\nType 'C' to Copy to clipboard", "D");
    
            if (choice === null) {
                displayStatus("Export cancelled.", 2000);
                return; // User cancelled prompt
            }
    
            const choiceUpper = choice.toUpperCase();
    
            if (choiceUpper === 'D') {
                // --- Download Logic ---
                try {
                    const jsonData = JSON.stringify(contractions, null, 2); // Pretty print
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    const now = new Date();
                    const timestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
                    link.download = `contraction_history_${timestamp}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    displayStatus("History exported as JSON file.", 3000);
                } catch (e) {
                     console.error("Error exporting history to file:", e);
                     displayStatus("Error exporting history file.", 5000);
                }
            } else if (choiceUpper === 'C') {
                // --- Copy to Clipboard Logic ---
                try {
                    const jsonDataPlain = JSON.stringify(contractions, null, 2); // Pretty print is fine for copy too
                     // Use Clipboard API
                     if (navigator.clipboard && navigator.clipboard.writeText) {
                         navigator.clipboard.writeText(jsonDataPlain).then(() => {
                            displayStatus("History copied to clipboard.", 3000);
                         }).catch(err => {
                            console.error('Clipboard write failed:', err);
                            // Fallback for older browsers or if permissions fail - using alert
                             alert("Could not copy automatically. Please manually copy the data below:\n\n" + jsonDataPlain);
                             displayStatus("History ready in alert box to copy manually.", 5000);
                         });
                     } else {
                          // Very basic fallback if clipboard API not supported at all
                          alert("Please manually copy the data below:\n\n" + jsonDataPlain);
                          displayStatus("History ready in alert box to copy manually.", 5000);
                     }
                } catch (e) {
                    console.error("Error preparing history for clipboard:", e);
                    displayStatus("Error copying history.", 5000);
                }
            } else {
                displayStatus("Invalid choice. Please type 'D' or 'C'.", 3000);
            }
        }
    
        // *** Import Handler ***
        function handleImportHistoryClick() {
            if (!importDataArea || !importHistoryButton) return;
            const pastedData = importDataArea.value.trim();
    
            if (!pastedData) {
                displayStatus("Paste exported data into the text area first.", 3000);
                return;
            }
    
            if (contractions.length > 0) {
                if (!confirm("Importing will replace your current history list. Continue?")) {
                    return; // User cancelled
                }
            }
    
            try {
                const parsedData = JSON.parse(pastedData);
                if (!isValidHistoryData(parsedData)) {
                     throw new Error("Imported data is not in the expected format (array of contraction records).");
                }
    
                contractions = parsedData;
                lastStartTime = contractions.length > 0 ? contractions[0].startTime : null;
    
                updateHistoryTable();
                updateTimeSinceLastDisplay();
                importDataArea.value = '';
                displayStatus("History imported successfully.", 3000);
    
            } catch (e) {
                console.error("Error importing history:", e);
                displayStatus(`Import failed: ${e.message}`, 5000);
            }
        }
    
        // --- Initialization ---
        let wasHistoryLoaded = loadHistoryFromStorage();
    
        // Add event listeners
        if (timerButton) timerButton.addEventListener('click', handleTimerClick);
        if (clearHistoryButton) clearHistoryButton.addEventListener('click', handleClearHistoryClick);
        if (saveHistoryButton) saveHistoryButton.addEventListener('click', handleSaveHistoryClick);
        if (exportHistoryButton) exportHistoryButton.addEventListener('click', handleExportHistoryClick);
        if (importHistoryButton) importHistoryButton.addEventListener('click', handleImportHistoryClick);
    
        // Initial render
        updateHistoryTable();
        updateTimeSinceLastDisplay();
    
        if (wasHistoryLoaded) {
           displayStatus("Loaded previously saved history.", 3000);
        }
    
    })();
    </script>